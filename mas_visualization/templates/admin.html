<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Smart Lab Assistant</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <style>
      /* --- Theme Color Variables --- */
      :root {
        --bg-color: #f8f9fa;
        --text-color: #212529;
        --card-bg-color: #ffffff;
        --border-color: #dee2e6;
        /* Variables for navbar and other elements */
        --primary-color: #0d6efd;
        --secondary-color: #6c757d;
        --accent-color: #4cc9f0;
        --text-light: rgba(255, 255, 255, 0.9);
      }

      body.dark-mode {
        --bg-color: #0a0e27;
        --text-color: #e9ecef;
        --card-bg-color: #1a1f3a;
        --border-color: rgba(255, 255, 255, 0.15);
      }

      /* --- General Page Styles --- */
      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--bg-color) !important;
        color: var(--text-color);
        transition: background-color 0.3s ease;
      }

      h2,
      .card-header h5,
      .section-toggle h5 {
        color: var(--text-color);
      }

      /* --- Component Styles (Cards, Tables, Forms) --- */
      .card,
      .overlay-card {
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 2rem;
      }
      body.dark-mode .card,
      body.dark-mode .overlay-card {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      }

      .card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--border-color);
      }

      .table {
        --bs-table-color: var(--text-color);
        --bs-table-border-color: var(--border-color);
        --bs-table-striped-bg: rgba(0, 0, 0, 0.02);
      }
      body.dark-mode .table {
        --bs-table-bg: transparent; /* Add this line */
        --bs-table-striped-bg: rgba(255, 255, 255, 0.03);
        --bs-table-striped-color: var(--text-color); /* Add this line */
        --bs-table-hover-bg: rgba(255, 255, 255, 0.05);
      }

      body.dark-mode .form-control,
      body.dark-mode .form-select {
        background-color: #0f1220;
        color: var(--text-color);
        border-color: var(--border-color);
      }

      body.dark-mode .dropdown-menu {
        background-color: var(--card-bg-color);
        border-color: var(--border-color);
      }
      body.dark-mode .dropdown-item {
        color: var(--text-color);
      }
      body.dark-mode .dropdown-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      body.dark-mode .dropdown-divider {
        border-top: 1px solid var(--border-color);
      }

      /* --- Section Toggles & Overlays --- */
      .section-toggle {
        cursor: pointer;
        padding: 10px 15px;
        background-color: #f0f2f5;
        border-radius: 5px;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
      }
      body.dark-mode .section-toggle {
        background-color: #0f1220;
      }
      .section-toggle:hover {
        background-color: #e9ecef;
      }
      body.dark-mode .section-toggle:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      .section-toggle.active {
        background-color: var(--primary-color);
        color: white;
      }

      .overlay-card {
        position: fixed;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }
      .overlay-card.show {
        transform: translateX(0);
      }
      .overlay-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      .overlay-backdrop.show {
        display: block;
      }
      .entries-select {
        width: auto;
        display: inline-block;
      }
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
      }
      .dataTables_wrapper {
        margin-top: 10px;
      }
      .section-content {
        display: none;
      }
      .section-content.active {
        display: block;
      }
      .nav-tabs .nav-link.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
      }

      /* --- Navbar Theme Support --- */
      .navbar {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        ) !important;
        transition: background 0.35s ease;
      }

      body.dark-mode .navbar {
        background: linear-gradient(135deg, #1a1f3a, #0a0e27) !important;
      }

      body.dark-mode .navbar-brand {
        color: var(--text-light) !important;
      }

      .navbar-toggler-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        margin-right: 10px;
      }

      .theme-toggle-label {
        color: var(--text-light);
        margin-right: 10px;
        font-weight: 500;
      }

      .form-check-input {
        background-color: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        width: 3.2em !important;
        height: 1.6em !important;
        cursor: pointer;
      }

      .form-check-input:checked {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
      }

      .nav-link {
        color: var(--text-light) !important;
        font-weight: 500;
        padding: 0.5rem 1rem !important;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin: 0 3px;
      }

      .nav-link:hover,
      .nav-link.active {
        background-color: rgba(255, 255, 255, 0.15);
        color: var(--accent-color) !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">
          <i class="fas fa-user-secret"></i> Smart Agentic Lab Assistant
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
            <li class="nav-item me-3">
              <div class="theme-toggle">
                <span class="theme-toggle-label">Dark Mode</span>
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    role="switch"
                    id="themeSwitch"
                  />
                  <label class="form-check-label" for="themeSwitch"></label>
                </div>
              </div>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/dashboard">
                <i class="fas fa-tachometer-alt me-1"></i> Dashboard
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link active" href="/admin">
                <i class="fas fa-cog me-1"></i> Admin Panel
              </a>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="fas fa-user-circle user-avatar"></i>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdown"
              >
                <li>
                  <a class="dropdown-item" href="/profile">
                    <i class="fas fa-user"></i> View Profile
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
      <h2 class="mb-4">Admin Dashboard</h2>

      <!-- Section Toggles -->
      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <div
            class="section-toggle text-center active"
            data-target="manage-users"
          >
            <h5><i class="fas fa-users-cog"></i> Manage Users</h5>
            <p class="mb-0">View and manage system users</p>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="section-toggle text-center" data-target="manage-labs">
            <h5><i class="fas fa-flask"></i> Manage Labs</h5>
            <p class="mb-0">View and manage laboratory facilities</p>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="section-toggle text-center" data-target="all-bookings">
            <h5><i class="fas fa-calendar-check"></i> All Bookings</h5>
            <p class="mb-0">View and manage all lab bookings</p>
          </div>
        </div>
      </div>

      <!-- Manage Users Section -->
      <div class="section-content active" id="manage-users">
        <div class="card shadow-sm">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0"><i class="fas fa-users-cog"></i> Manage Users</h5>
            <div>
              <button class="btn btn-success btn-sm" id="addUserBtn">
                <i class="fas fa-plus"></i> Add New User
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="usersTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in users %}
                  <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.role }}</td>
                    <td>
                      {% if user.role != 'super_admin' %}
                      <button
                        class="btn btn-danger btn-sm"
                        onclick="deleteUser('{{ user.id }}')"
                      >
                        <i class="fas fa-trash-alt"></i> Delete
                      </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="pagination-container">
              <div>
                Show
                <select
                  class="form-select form-select-sm entries-select"
                  id="usersEntriesSelect"
                >
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="-1">All</option>
                </select>
                entries
              </div>
              <div>
                <nav>
                  <ul
                    class="pagination pagination-sm mb-0"
                    id="usersPagination"
                  >
                    <!-- Pagination will be generated by JavaScript -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Manage Labs Section -->
      <div class="section-content" id="manage-labs">
        <div class="card shadow-sm">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0"><i class="fas fa-flask"></i> Manage Labs</h5>
            <div>
              <button class="btn btn-success btn-sm" id="addLabBtn">
                <i class="fas fa-plus"></i> Add New Lab
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="labsTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Capacity</th>
                    <th>Description</th>
                    <th>Equipment</th>
                    <th>Hours</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for lab in labs %}
                  <tr>
                    <td>{{ lab.id }}</td>
                    <td>{{ lab.name }}</td>
                    <td>{{ lab.capacity }}</td>
                    <td>{{ lab.description }}</td>
                    <td>{{ lab.equipment }}</td>
                    <td>
                      {{ lab.operating_start_time }} - {{ lab.operating_end_time
                      }}
                    </td>
                    <td>
                      <button
                        class="btn btn-danger btn-sm"
                        onclick="deleteLab('{{ lab.id }}')"
                      >
                        <i class="fas fa-trash-alt"></i> Delete
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="pagination-container">
              <div>
                Show
                <select
                  class="form-select form-select-sm entries-select"
                  id="labsEntriesSelect"
                >
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="-1">All</option>
                </select>
                entries
              </div>
              <div>
                <nav>
                  <ul class="pagination pagination-sm mb-0" id="labsPagination">
                    <!-- Pagination will be generated by JavaScript -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- All Bookings Section -->
      <div class="section-content" id="all-bookings">
        <div class="card shadow-sm">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0">
              <i class="fas fa-calendar-check"></i> All Bookings
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="bookingsTable">
                <thead>
                  <tr>
                    <th>Booking ID</th>
                    <th>Lab Name</th>
                    <th>Booked By</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Students</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for booking in bookings %}
                  <tr>
                    <td>{{ booking.id }}</td>
                    <td>{{ booking.lab_name }}</td>
                    <td>{{ booking.booked_by_name }}</td>
                    <td>{{ booking.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ booking.end_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ booking.student_count }}</td>
                    <td>
                      <button
                        class="btn btn-danger btn-sm"
                        onclick="deleteBooking('{{ booking.id }}')"
                      >
                        <i class="fas fa-trash-alt"></i> Delete
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="pagination-container">
              <div>
                Show
                <select
                  class="form-select form-select-sm entries-select"
                  id="bookingsEntriesSelect"
                >
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="-1">All</option>
                </select>
                entries
              </div>
              <div>
                <nav>
                  <ul
                    class="pagination pagination-sm mb-0"
                    id="bookingsPagination"
                  >
                    <!-- Pagination will be generated by JavaScript -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay Backdrop -->
    <div class="overlay-backdrop" id="overlayBackdrop"></div>

    <!-- Add User Overlay Card -->
    <div class="overlay-card" id="addUserCard">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Add New User</h4>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          id="closeAddUserCard"
        ></button>
      </div>
      <form id="addUserForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required />
          </div>
          <div class="col-md-6 mb-3">
            <label for="fullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" required />
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">Email (@iitj.ac.in)</label>
            <input
              type="email"
              class="form-control"
              id="email"
              required
              pattern=".+@iitj\.ac\.in$"
            />
          </div>
          <div class="col-md-6 mb-3">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="password"
              required
            />
          </div>
        </div>
        <div class="mb-3">
          <label for="role" class="form-label">Role</label>
          <select class="form-select" id="role" required>
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Add User</button>
      </form>
    </div>

    <!-- Add Lab Overlay Card -->
    <div class="overlay-card" id="addLabCard">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Add New Lab</h4>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          id="closeAddLabCard"
        ></button>
      </div>
      <form id="addLabForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="name" class="form-label">Lab Name</label>
            <input type="text" class="form-control" id="name" required />
          </div>
          <div class="col-md-6 mb-3">
            <label for="capacity" class="form-label">Capacity</label>
            <input type="number" class="form-control" id="capacity" required />
          </div>
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea class="form-control" id="description" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label for="equipment" class="form-label"
            >Equipment (comma-separated)</label
          >
          <input type="text" class="form-control" id="equipment" />
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="start_time" class="form-label"
              >Operating Start Time</label
            >
            <input type="time" class="form-control" id="start_time" />
          </div>
          <div class="col-md-6 mb-3">
            <label for="end_time" class="form-label">Operating End Time</label>
            <input type="time" class="form-control" id="end_time" />
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Lab</button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <script>
      // Authentication token
      const token = localStorage.getItem("accessToken");

      // Section toggle functionality
      document.querySelectorAll(".section-toggle").forEach((toggle) => {
        toggle.addEventListener("click", function () {
          // Remove active class from all toggles
          document.querySelectorAll(".section-toggle").forEach((t) => {
            t.classList.remove("active");
          });

          // Add active class to clicked toggle
          this.classList.add("active");

          // Hide all sections
          document.querySelectorAll(".section-content").forEach((section) => {
            section.classList.remove("active");
          });

          // Show selected section
          const targetId = this.getAttribute("data-target");
          document.getElementById(targetId).classList.add("active");
        });
      });

      // Overlay card functionality
      function showOverlayCard(cardId) {
        document.getElementById(cardId).classList.add("show");
        document.getElementById("overlayBackdrop").classList.add("show");
      }

      function hideOverlayCard(cardId) {
        document.getElementById(cardId).classList.remove("show");
        document.getElementById("overlayBackdrop").classList.remove("show");
      }

      // Event listeners for buttons
      document
        .getElementById("addUserBtn")
        .addEventListener("click", () => showOverlayCard("addUserCard"));
      document
        .getElementById("closeAddUserCard")
        .addEventListener("click", () => hideOverlayCard("addUserCard"));

      document
        .getElementById("addLabBtn")
        .addEventListener("click", () => showOverlayCard("addLabCard"));
      document
        .getElementById("closeAddLabCard")
        .addEventListener("click", () => hideOverlayCard("addLabCard"));

      // Close overlay when clicking on backdrop
      document
        .getElementById("overlayBackdrop")
        .addEventListener("click", () => {
          document.querySelectorAll(".overlay-card").forEach((card) => {
            card.classList.remove("show");
          });
          document.getElementById("overlayBackdrop").classList.remove("show");
        });

      // Table pagination functionality
      function setupPagination(
        tableId,
        entriesSelectId,
        paginationId,
        pageSize = 10
      ) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll("tbody tr");
        const entriesSelect = document.getElementById(entriesSelectId);
        const pagination = document.getElementById(paginationId);

        let currentPage = 1;

        function showPage(page) {
          const startIndex = (page - 1) * pageSize;
          const endIndex = startIndex + pageSize;

          rows.forEach((row, index) => {
            if (index >= startIndex && index < endIndex) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });

          updatePaginationButtons();
        }

        function updatePaginationButtons() {
          const totalPages = Math.ceil(rows.length / pageSize);
          pagination.innerHTML = "";

          // Previous button
          const prevLi = document.createElement("li");
          prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
          prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
          prevLi.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage > 1) {
              currentPage--;
              showPage(currentPage);
            }
          });
          pagination.appendChild(prevLi);

          // Page numbers
          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = `page-item ${currentPage === i ? "active" : ""}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", (e) => {
              e.preventDefault();
              currentPage = i;
              showPage(currentPage);
            });
            pagination.appendChild(li);
          }

          // Next button
          const nextLi = document.createElement("li");
          nextLi.className = `page-item ${
            currentPage === totalPages ? "disabled" : ""
          }`;
          nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
          nextLi.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
              currentPage++;
              showPage(currentPage);
            }
          });
          pagination.appendChild(nextLi);
        }

        // Initialize entries select
        entriesSelect.value = pageSize;
        entriesSelect.addEventListener("change", () => {
          const newPageSize = parseInt(entriesSelect.value);
          if (newPageSize === -1) {
            pageSize = rows.length;
          } else {
            pageSize = newPageSize;
          }
          currentPage = 1;
          showPage(currentPage);
        });

        // Initialize pagination
        showPage(currentPage);
      }

      // Initialize pagination for all tables
      document.addEventListener("DOMContentLoaded", () => {
        setupPagination("usersTable", "usersEntriesSelect", "usersPagination");
        setupPagination("labsTable", "labsEntriesSelect", "labsPagination");
        setupPagination(
          "bookingsTable",
          "bookingsEntriesSelect",
          "bookingsPagination"
        );
      });

      //  WebSocket Connection for Real-time Updates
      const ws = new WebSocket(`ws://localhost:8000/ws?token=${token}`);
      ws.onmessage = function (event) {
        const message = JSON.parse(event.data);
        if (
          message.type === "users_updated" ||
          message.type === "labs_updated"
        ) {
          Toastify({
            text: "Admin data changed. Refreshing...",
            backgroundColor: "linear-gradient(to right, #667eea, #764ba2)",
          }).showToast();
          setTimeout(() => location.reload(), 1500);
        }
      };

      // Function to delete a user
      async function deleteUser(userId) {
        if (!confirm(`Are you sure you want to delete user with ID ${userId}?`))
          return;
        try {
          const response = await fetch(`/users/delete/${userId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Failed to delete user");
          }
        } catch (error) {
          Toastify({
            text: `Error: ${error.message}`,
            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
          }).showToast();
        }
      }

      // Function to delete a lab
      async function deleteLab(labId) {
        if (
          !confirm(
            `Are you sure you want to delete lab with ID ${labId}? This will also delete all its bookings.`
          )
        )
          return;
        try {
          const response = await fetch(`/api/labs/${labId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Failed to delete lab");
          }
        } catch (error) {
          Toastify({
            text: `Error: ${error.message}`,
            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
          }).showToast();
        }
      }

      // Function to delete a booking
      async function deleteBooking(bookingId) {
        if (
          !confirm(
            `Are you sure you want to delete booking with ID ${bookingId}?`
          )
        )
          return;
        try {
          const response = await fetch(`/api/bookings/${bookingId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Failed to delete booking");
          }
          Toastify({
            text: "Booking deleted successfully!",
            backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
          }).showToast();
          setTimeout(() => location.reload(), 1500);
        } catch (error) {
          Toastify({
            text: `Error: ${error.message}`,
            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
          }).showToast();
        }
      }

      // Event listener for the Add User form
      document
        .getElementById("addUserForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const userData = {
            username: document.getElementById("username").value,
            full_name: document.getElementById("fullName").value,
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
            role: document.getElementById("role").value,
          };
          try {
            const response = await fetch("/api/users/admin-create", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(userData),
            });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Failed to add user");
            }
            // No need for Toastify/reload here, WebSocket will handle it
            document.getElementById("addUserForm").reset(); // Clear the form
            hideOverlayCard("addUserCard");
          } catch (error) {
            Toastify({
              text: `Error: ${error.message}`,
              backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
            }).showToast();
          }
        });

      // Event listener for the Add Lab form
      document
        .getElementById("addLabForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const labData = {
            name: document.getElementById("name").value,
            capacity: parseInt(document.getElementById("capacity").value),
            description: document.getElementById("description").value,
            equipment: document.getElementById("equipment").value,
            operating_start_time:
              document.getElementById("start_time").value || null,
            operating_end_time:
              document.getElementById("end_time").value || null,
          };

          try {
            const response = await fetch("/api/labs", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(labData),
            });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Failed to add lab");
            }
            document.getElementById("addLabForm").reset(); // Clear the form
            hideOverlayCard("addLabCard");
          } catch (error) {
            Toastify({
              text: `Error: ${error.message}`,
              backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
            }).showToast();
          }
        });

      // Theme Toggle Functionality
      const themeSwitch = document.getElementById("themeSwitch");

      // Check for saved theme preference
      const currentTheme = localStorage.getItem("theme");
      if (currentTheme) {
        document.body.classList.add(currentTheme);
        if (currentTheme === "dark-mode") themeSwitch.checked = true;
      }

      // Theme switch event listener
      themeSwitch.addEventListener("change", function () {
        if (themeSwitch.checked) {
          document.body.classList.add("dark-mode");
          localStorage.setItem("theme", "dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
          localStorage.setItem("theme", "light-mode");
        }
      });

      // Logout functionality
      document
        .getElementById("logoutBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          localStorage.removeItem("accessToken");
          window.location.href = "/login";
        });
    </script>
  </body>
</html>
